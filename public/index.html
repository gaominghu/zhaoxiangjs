<html>
<body>
  <!--<canvas id="preview" width="1056" height="704"></canvas>-->
  <div id="imageWrap">
    <img src="" alt="Main Image" id="mainImage" width="800px"/>
  </div>
  <div id="downloads"></div>
  <script type="text/javascript" src="//www.google.com/jsapi"></script>
  <script type="text/javascript" src="/js/dat.gui.js"></script>
  <script src='//cdnjs.cloudflare.com/ajax/libs/superagent/0.15.7/superagent.min.js'></script>

  <script type="text/javascript">
    google.load('jquery', '1.7.1');
  </script>
  <script type="text/coffeescript">
    request = superagent
    class GPhoto
      lastPicture: ()->
        request.get 'lastPicture', download:true, (res)=>
          console.log res
          if res.text
            $('#mainImage').attr('src', res.text);

      startPreview: ()->
        request.get '/api/stream/start', (res) =>
          console.log res
        $('#mainImage').attr('src', 'http://' + window.location.hostname + ':8080' + '/?action=stream');

      stopPreview: ()->
        $('#img').unbind('load')
      loadSettings: (cb)=>
        request.get '/api/settings', (settings)=>
          cb JSON.parse(settings.text) if cb

      enumSettings: (settings, gui)=>
        unless gui
          gui = @gui
        $.each settings, (key, val)=>
          if val.type in ['window', 'section']
            @enumSettings val.children, gui.addFolder val.label
          else
            foo ={}
            foo[val.label] = val.value
            changeFn = (newValue)->
                console.log val.label, "changed to", newValue
                request.put "/api/settings/#{key}", newValue:newValue, (response)->
                  console.log response
            if val.type is 'string'
              gui.add(foo, val.label).onChange changeFn
            else if val.type is 'toggle'
              foo[val.label] = val.value != 0
              gui.add(foo, val.label).onChange (newValue)->
                request.put "/api/settings/#{key}", newValue: (if newValue then 1 else 0), (response)->
                  console.log response
            else if val.type is 'choice'
              gui.add(foo, val.label, val.choices).onChange(changeFn)
            else if val.type is 'range'
              gui.add(foo, val.label, val.min, val.max, val.step).onChange(changeFn)


      displaySettings: ()=>
        @gui = new dat.GUI() unless @gui
        foo =
          'Start live preview' : ()=>
            @startPreview()
          'Take picture': ()=>
            request.get '/api/shoot/jpeg', (res)=>
              console.log res
              if res.text
                $('#mainImage').attr('src', res.text);
                $('<a>').attr('href', res.text).text(res.text).appendTo($('#downloads')).css('display':'block')

        @gui.add foo, 'Take picture'
        @gui.add foo, 'Start live preview'
        @loadSettings @enumSettings


    window.gphoto = new GPhoto()
    window.gphoto.displaySettings()
  </script>
  </script>
  <script type="text/javascript" src="http://coffeescript.org/extras/coffee-script.js"></script>

</body>
</html>
